//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
// Copyright (c) 2017 Retargetable Decompiler <info@retdec.com>
//

#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

// ------------------- Function Prototypes --------------------

int32_t fastboot_handler(int32_t a1, int32_t a2);
int32_t handle_fboot_command_reboot(int32_t a1, int32_t a2);

// --------------------- Global Variables ---------------------

int32_t g23 = 0; // LR
int32_t g24 = 0; // R0
int32_t g25 = 0; // R2
int32_t g26 = 0; // R3
int32_t g27 = 0; // R4
int32_t g1 = -0x16d2bf10; // 0x8f621a7c
int32_t g2 = -0x16d2b801; // 0x8f621dcc
int32_t g3 = -0x16d2bf09; // 0x8f622f94
int32_t g4 = -0x16d2bc10; // 0x8f623c30
int32_t g5 = -0x16d2bf8d; // 0x8f623db0
int32_t g6 = -0x16d2b010; // 0x8f62d370
int32_t g7 = -0x16d2bfed; // 0x8f638714
int32_t g8 = -0x16d2bc09; // 0x8f638ab0
int32_t g10 = 0x746e6300; // 0x8f6a4e20
int32_t g11 = 1; // 0x8f6ac0f0
int32_t g12 = 0; // 0x8f6c0390
int32_t g13 = 0; // 0x8f6c0398
int32_t g14 = 0; // 0x8f6c03d0
int32_t g15 = 0; // 0x8f7112f4
int32_t g16 = 0; // 0x8f7114f4
int32_t g17 = 0; // 0x8f7114f8
int32_t g18 = 0; // 0x8f7114fc
int32_t g19 = 0; // 0x8f711508
int32_t g20 = 0; // 0x8f71150c
int32_t g21 = 0; // 0x8f711510
int32_t g22 = 0; // 0x8f711534
char * g9[13] = {
    "download",
    (char *)&g1,
    "flash",
    (char *)&g3,
    "multiflash",
    (char *)&g4,
    "getvar",
    (char *)&g6,
    "erase",
    (char *)&g5,
    "boot",
    (char *)&g2,
    "reboot"
}; // 0x8f68422c

// ------------------------ Functions -------------------------

// Address range: 0x8f621660 - 0x8f62192b
int32_t fastboot_handler(int32_t a1, int32_t a2) {
    int32_t v1 = a2; // R1
    int32_t v2 = g15; // R3
    int32_t str;
    int32_t v3 = &str; // 0x8f621678_0
    g27 = v3;
    event_wait((int32_t)&g22, a2);
    // branch -> 0x8f62168c
    int32_t v4; // 0x8f6216cc
    int32_t v5; // R5
    int32_t v6; // R9
    int32_t v7;
    while (true) {
      lab_0x8f62168c_5:
        // 0x8f62168c
        v6 = &g14;
        v5 = 0;
        mutex_acquire((int32_t)&g13, v1, g25, v2, v7, 0, 0, 0, 0, 0);
        *(int32_t *)v6 = v5;
        mutex_release((int32_t)&g13, v1, g25, v2, v7, 0);
        g25 = 64;
        memset((char *)&str, v5, 64);
        function_8f6193d4(v3, 64);
        v1 = 64;
        v4 = fboot_usb_read(v3, 64, g25, v2, v7, 0, 0, 0, 0, 0, str, 0, 0, 0);
        if (v4 != -13) {
            // break -> 0x8f6216dc
            break;
        }
        // continue -> 0x8f62168c
    }
    // 0x8f6216dc
    if (v4 < v5) {
      lab_0x8f6216e4:
        // 0x8f6216e4
        v1 = (int32_t)"%s: usb disconnected, start waiting for usb online\n";
        g25 = (int32_t)"fastboot_command_handler";
        print_log(1, (int32_t)"%s: usb disconnected, start waiting for usb online\n", (int32_t)"fastboot_command_handler", v2, v7, 0, 0, 0, 0, 0, str, 0, 0);
        event_wait((int32_t)&g22, v1);
        // branch -> 0x8f62168c
        goto lab_0x8f62168c_5;
    }
  lab_0x8f621700:
    // 0x8f621700
    mutex_acquire((int32_t)&g13, v1, g25, v2, v7, 0, 0, 0, 0, 0);
    *(int32_t *)v6 = 1;
    mutex_release((int32_t)&g13, v1, g25, 1, v7, 0);
    show((int32_t)"fastboot_screen", v5, g25, (int32_t)&g8, v7, 0, 0, 0, 0, 0, str, 0, 0);
    print_log(6, (int32_t)"cmd: %s\n", v3, (int32_t)&g8, v7, 0, 0, 0, 0, 0, str, 0, 0);
    // branch -> 0x8f621740
    while (true) {
      lab_0x8f621740:;
        int32_t v8 = v3 + 1; // 0x8f621744
        g25 = v8;
        char * v9 = (char *)v3; // 0x8f621744_0
        char v10 = *v9; // 0x8f621744
        v2 = v10;
        switch (v10) {
            case 0: {
              lab_0x8f621764_2:
                // 0x8f621764
                v5 = 0;
                int32_t v11 = 0; // 0x8f621770
                // branch -> 0x8f62176c
                while (true) {
                    int32_t str2 = *(int32_t *)(8 * v11 + (int32_t)&g9); // 0x8f621770
                    int32_t strcmp_rc = strcmp((char *)&str, (char *)str2); // 0x8f621774
                    uint32_t v12 = v5; // 0x8f621778
                    int32_t v13 = 8 * v12; // R10
                    if (strcmp_rc == 0) {
                        int32_t str3 = *(int32_t *)(8 * v12 + (int32_t)&g9); // 0x8f621788
                        int32_t v14 = v12 % 256; // R6
                        int32_t v15 = g27 + strlen((char *)str3); // 0x8f621798
                        g19 = v15;
                        disconnect_key(v15, str2, g25);
                        int32_t v16 = g21; // 0x8f6217ac
                        v5 = v16;
                        int32_t v17;
                        int32_t v18; // 0x8f621828
                        int32_t v19; // 0x8f6218b8
                        int32_t v20; // 0x8f621820
                        int32_t v21; // 0x8f621818
                        if (v16 != (int32_t)&g20) {
                            bool v22 = true;
                            int32_t v23;
                            while (true) {
                                bool v24 = v22;
                                int32_t v25; // 0x8f6217e0
                                if ((int32_t)*(char *)(v16 + 8) == v14) {
                                    int32_t v26 = *(int32_t *)(v16 + 12); // 0x8f6217f0
                                    g26 = v26;
                                    if (v26 != 0) {
                                        // 0x8f6217fc
                                        g24 = &g18;
                                        g23 = -0x709de7fc;
                                        ((int32_t (*)(int32_t))v26)((int32_t)&g18);
                                        int32_t v27 = g24; // 0x8f621804
                                        v23 = (int32_t)"OKAY";
                                        if (v27 != 0) {
                                            // 0x8f62180c
                                            if (v27 != 3) {
                                                // 0x8f62180c
                                                v24 = true;
                                                // branch -> 0x8f6217e0
                                                // 0x8f6217e0
                                                v25 = *(int32_t *)(v5 + 4);
                                                v5 = v25;
                                                if (v25 == (v24 ? (int32_t)&g20 : 0)) {
                                                    // break (via goto) -> 0x8f621818
                                                    goto lab_0x8f621818_2;
                                                }
                                                v22 = v24;
                                                v16 = v25;
                                                // continue -> 0x8f6217d4
                                                continue;
                                            } else {
                                                v23 = (int32_t)"FAIL";
                                            }
                                        }
                                      lab_0x8f6218a0_5:
                                        // 0x8f6218a0
                                        g24 = fboot_ack(v23, (int32_t)&g10, g25, g26, 0, 0, 0, 0, 0, 0);
                                        // branch -> 0x8f6218a8
                                      lab_0x8f6218a8_2:
                                        // 0x8f6218a8
                                        g25 = &g12;
                                        v1 = (int32_t)"\n\n";
                                        v17 = g12;
                                        *(char *)(v17 + (int32_t)"\n\n") = (char)v14;
                                        if (false) {
                                          lab_if_8f6218c4_0_true_2:;
                                            // if_8f6218c4_0_true
                                            // branch -> after_if_8f6218cc_0
                                        }
                                      lab_after_if_8f6218cc_0:
                                        // after_if_8f6218cc_0
                                        *(int32_t *)g25 = (v17 + 1) % 2;
                                        v2 = &g7;
                                        connect_key(g24, v1, g25);
                                        // branch -> 0x8f62168c
                                        goto lab_0x8f62168c_5;
                                    } else {
                                        v24 = v22;
                                    }
                                }
                                // 0x8f6217e0
                                v25 = *(int32_t *)(v16 + 4);
                                v5 = v25;
                                if (v25 == (v24 ? (int32_t)&g20 : 0)) {
                                    // break (via goto) -> 0x8f621818
                                    goto lab_0x8f621818_2;
                                }
                                v22 = v24;
                                v16 = v25;
                                // continue -> 0x8f6217d4
                            }
                            int32_t v28 = v13; // 0x8f621818
                            int32_t v29 = v6; // 0x8f621818
                            v21 = v29 + v28;
                            v6 = v21;
                            g24 = &g18;
                            v20 = *(int32_t *)(v21 + 4);
                            g26 = v20;
                            g23 = -0x709de7d8;
                            ((int32_t (*)(int32_t, int32_t))v20)((int32_t)&g18, v20);
                            v18 = g24;
                            switch (v18) {
                                default: {
                                    // 0x8f621838
                                    if (v18 == 3) {
                                        v23 = (int32_t)"FAIL";
                                        goto lab_0x8f6218a0_5;
                                    }
                                  lab_0x8f621840:
                                    // 0x8f621840
                                    g26 = &g16;
                                    int32_t v30 = g17; // 0x8f621844
                                    v5 = v30;
                                    if (v30 != (int32_t)&g16) {
                                        int32_t v31 = &g16; // 0x8f62184c25
                                        while (true) {
                                            int32_t v32 = (int32_t)*(char *)(v30 + 8); // 0x8f621854
                                            g26 = v32;
                                            int32_t v33 = v18; // 0x8f62188c27
                                            int32_t v34 = v31; // 0x8f62184c
                                            int32_t v35 = v30; // 0x8f621884
                                            if (v32 == v14) {
                                                int32_t v36 = *(int32_t *)(v30 + 12); // 0x8f621860
                                                g26 = v36;
                                                if (v36 != 0) {
                                                    // 0x8f62186c
                                                    g24 = &g18;
                                                    g23 = -0x709de78c;
                                                    ((int32_t (*)(int32_t))v36)((int32_t)&g18);
                                                    int32_t v37 = g24; // 0x8f621874
                                                    if (v37 == 0) {
                                                        v23 = (int32_t)"OKAY";
                                                        goto lab_0x8f6218a0_5;
                                                    }
                                                    // 0x8f62187c
                                                    if (v37 == 3) {
                                                        v23 = (int32_t)"FAIL";
                                                        goto lab_0x8f6218a0_5;
                                                    }
                                                    // 0x8f62187c
                                                    v33 = v37;
                                                    v34 = &g16;
                                                    v35 = v5;
                                                    // branch -> 0x8f621884
                                                } else {
                                                    v33 = v18;
                                                    v34 = v31;
                                                    v35 = v30;
                                                }
                                            }
                                            int32_t v38 = *(int32_t *)(v35 + 4); // 0x8f621884
                                            v5 = v38;
                                            if (v38 == v34) {
                                                v18 = v33;
                                                // break (via goto) -> 0x8f62188c
                                                goto lab_0x8f62188c;
                                            }
                                            v18 = v33;
                                            v31 = v34;
                                            v30 = v38;
                                            // continue -> 0x8f621854
                                        }
                                        // 0x8f62188c
                                        if (v18 == 2) {
                                            goto lab_0x8f6218a8_2;
                                        }
                                        v23 = (int32_t)"OKAY";
                                        goto lab_0x8f6218a0_5;
                                    }
                                  lab_0x8f62188c:
                                    // 0x8f62188c
                                    if (v18 == 2) {
                                        goto lab_0x8f6218a8_2;
                                    }
                                    v23 = (int32_t)"OKAY";
                                    goto lab_0x8f6218a0_5;
                                    break;
                                }
                                case 5: {
                                  lab_0x8f6218a8_3:
                                    // 0x8f6218a8
                                    g25 = &g12;
                                    v1 = (int32_t)"\n\n";
                                    v17 = g12;
                                    *(char *)(v17 + (int32_t)"\n\n") = (char)v14;
                                    goto lab_after_if_8f6218cc_0;
                                    break;
                                }
                                case 0: {
                                    v23 = (int32_t)"OKAY";
                                  lab_0x8f6218a0_6:
                                    // 0x8f6218a0
                                    g24 = fboot_ack((int32_t)"FAIL", (int32_t)&g10, g25, g26, 0, 0, 0, 0, 0, 0);
                                    // branch -> 0x8f6218a8
                                    goto lab_0x8f6218a8_3;
                                    break;
                                }
                            }
                          lab_after_if_8f6218cc_0_2:
                            // after_if_8f6218cc_0
                            *(int32_t *)g25 = v19 % 2;
                            v2 = &g7;
                            connect_key(g24, v1, g25);
                            // branch -> 0x8f62168c
                            goto lab_0x8f62168c_5;
                        }
                      lab_0x8f621818_2:
                        // 0x8f621818
                        v21 = (int32_t)&g9 + v13;
                        g24 = &g18;
                        v20 = *(int32_t *)(v21 + 4);
                        g26 = v20;
                        g23 = -0x709de7d8;
                        ((int32_t (*)(int32_t, int32_t))v20)((int32_t)&g18, v20);
                        v18 = g24;
                        switch (v18) {
                            default: {
                                // 0x8f621838
                                if (v18 == 3) {
                                    goto lab_0x8f6218a0_6;
                                }
                                goto lab_0x8f621840;
                                break;
                            }
                            case 5: {
                              lab_0x8f6218a8_4:
                                // 0x8f6218a8
                                g25 = &g12;
                                v1 = (int32_t)"\n\n";
                                v17 = g12;
                                *(char *)(v17 + (int32_t)"\n\n") = (char)v14;
                                v19 = v17 + 1;
                                goto lab_after_if_8f6218cc_0_2;
                                break;
                            }
                            case 0: {
                                // 0x8f6218a0
                                g24 = fboot_ack((int32_t)"OKAY", (int32_t)&g10, g25, g26, 0, 0, 0, 0, 0, 0);
                                // branch -> 0x8f6218a8
                                goto lab_0x8f6218a8_4;
                                break;
                            }
                        }
                        int32_t v39 = g25; // 0x8f6218d0
                        *(int32_t *)v39 = v19 % 2;
                        v2 = &g7;
                        int32_t v40 = g24; // 0x8f6218d8
                        int32_t v41 = v1; // 0x8f6218d8
                        int32_t v42 = g25; // 0x8f6218d8
                        connect_key(v40, v41, v42);
                        // branch -> 0x8f62168c
                        goto lab_0x8f62168c_5;
                    } else {
                        int32_t v43 = v12 + 1; // 0x8f6217b8
                        v5 = v43;
                        if (v43 == 10) {
                            // 0x8f6217c4
                            v1 = (int32_t)"Unknown command";
                            fboot_ack((int32_t)"FAIL", (int32_t)"Unknown command", g25, v2, v7, 0, 0, 0, 0, 0);
                            // branch -> 0x8f62168c
                            goto lab_0x8f62168c_5;
                        } else {
                            // 0x8f6217b8
                            v11 = v43;
                            // branch -> 0x8f62176c
                            continue;
                        }
                    }
                    v6 = &g14;
                    v5 = 0;
                    int32_t v44 = v1; // 0x8f621698
                    int32_t v45 = g25; // 0x8f621698
                    int32_t v46 = v2; // 0x8f621698
                    mutex_acquire((int32_t)&g13, v44, v45, v46, v7, 0, 0, 0, 0, 0);
                    int32_t v47 = v6; // 0x8f6216a0
                    int32_t v48 = v5; // 0x8f6216a0
                    *(int32_t *)v47 = v48;
                    int32_t v49 = v1; // 0x8f6216a4
                    int32_t v50 = g25; // 0x8f6216a4
                    int32_t v51 = v2; // 0x8f6216a4
                    mutex_release((int32_t)&g13, v49, v50, v51, v7, 0);
                    g25 = 64;
                    int32_t v52 = v5; // 0x8f6216ac
                    memset((char *)&str, v52, 64);
                    function_8f6193d4(v3, 64);
                    v1 = 64;
                    int32_t v53 = g25; // 0x8f6216cc
                    int32_t v54 = v2; // 0x8f6216cc
                    int32_t v55 = str; // 0x8f6216cc
                    v4 = fboot_usb_read(v3, 64, v53, v54, v7, 0, 0, 0, 0, 0, v55, 0, 0, 0);
                    while (v4 == -13) {
                        // 0x8f62168c
                        v6 = &g14;
                        v5 = 0;
                        v44 = v1;
                        v45 = g25;
                        v46 = v2;
                        mutex_acquire((int32_t)&g13, v44, v45, v46, v7, 0, 0, 0, 0, 0);
                        v47 = v6;
                        v48 = v5;
                        *(int32_t *)v47 = v48;
                        v49 = v1;
                        v50 = g25;
                        v51 = v2;
                        mutex_release((int32_t)&g13, v49, v50, v51, v7, 0);
                        g25 = 64;
                        v52 = v5;
                        memset((char *)&str, v52, 64);
                        function_8f6193d4(v3, 64);
                        v1 = 64;
                        v53 = g25;
                        v54 = v2;
                        v55 = str;
                        v4 = fboot_usb_read(v3, 64, v53, v54, v7, 0, 0, 0, 0, 0, v55, 0, 0, 0);
                        // continue -> 0x8f62168c
                    }
                    int32_t v56 = v5; // 0x8f6216dc
                    if (v4 < v56) {
                        goto lab_0x8f6216e4;
                    }
                    goto lab_0x8f621700;
                }
                break;
            }
            case 58: {
                // 0x8f62175c
                v2 = 0;
                *v9 = 0;
                // branch -> 0x8f621764
                goto lab_0x8f621764_2;
                break;
            }
            case 32: {
                // 0x8f62175c
                v2 = 0;
                *v9 = 0;
                // branch -> 0x8f621764
                goto lab_0x8f621764_2;
                break;
            }
            default: {
                v3 = v8;
                goto lab_0x8f621740;
            }
        }
    }
}

// --------------- Statically Linked Functions ----------------

// void __stack_chk_fail(void);
// void * memset(void * s, int c, size_t n);
// int strcmp(const char * s1, const char * s2);
// size_t strlen(const char * s);

// --------------------- Meta-Information ---------------------

// Detected compiler/packer: android-ndk-r8 (4.4.3 armv5te, armv7a(arm-linux-androideabi-gcc))
// Detected functions: 2
// Decompiler release: v2.2.1 (2016-09-07)
// Decompilation date: 2017-08-06 05:29:21
